#!/usr/bin/env bash

# Usage: ./bin/make-gke-test-cluster <project> <zone> <clustername>
#   Configure a kubernetes cluster for running pool-based integration tests and running pools in general.
#    NOTE: This script labels any clusters it creates and will DELETE old clusters it created.
#   <project> is a gcloud project.
#   <zone> can be a zone. E.g., us-central1-a
#   <clustername> is the name of a cluster. E.g., 'test-cluster-1'

set -e

ZONE=$1

# Nuke all existing temporary clusters; don't want to keep on making more idle clusters each time you invoke this.
echo "---- Deleting any existing temporary clusters."
gcloud container clusters list --filter 'resourceLabels.longevity=temporary'
for i in `gcloud container clusters list --filter 'resourceLabels.longevity=temporary' --format="value(name)"`
do
    gcloud --quiet container clusters delete $i --zone $ZONE
done
